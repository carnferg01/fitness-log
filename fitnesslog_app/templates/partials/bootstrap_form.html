{# templates/partials/bootstrap_form.html #}

{% load custom_filters %}

{% if form.non_field_errors %}
  <div class="alert alert-danger">
    {{ form.non_field_errors|striptags }}
  </div>
{% endif %}

{% for field in form %}
  <div class="mb-3">
    <label for="{{ field.id_for_label }}" class="form-label">{{ field.label }}</label>
    {% with vm|activity_placeholder:field.name as placeholder %}

      <!-- Textarea -->
      {% if field.field.widget.input_type == "textarea" %}
        <textarea
          name="{{ field.name }}"
          class="form-control{% if field.errors %} is-invalid{% endif %}"
          id="{{ field.id_for_label }}"
          placeholder="{{ placeholder|default:'' }}"
        >{{ field.value|default_if_none:'' }}</textarea>

      <!-- Select -->
      {% elif field.field.widget.input_type == "select" %}
      <select
        name="{{ field.name }}{% if field.field.widget.allow_multiple_selected %}[]{% endif %}"
        class="form-select{% if field.errors %} is-invalid{% endif %}"
        id="{{ field.id_for_label }}"
        {% if field.field.widget.allow_multiple_selected %}multiple{% endif %}>
        {% for option in field.field.choices %}
          <option value="{{ option.0 }}" 
            {% if field.field.widget.allow_multiple_selected %}
              {% if option.0 in field.value %}
                selected
              {% endif %}
            {% else %}
              {% if option.0|stringformat:"s" == field.value|stringformat:"s" %}
                selected
              {% endif %}
            {% endif %}>
            {{ option.1 }}
          </option>
        {% endfor %}
      </select>

      <!-- Checkbox-->
      {% elif field.field.widget.input_type == "checkbox" %}
      <div class="form-check form-switch">
        <input
          type="checkbox"
          name="{{ field.name }}"
          class="form-check-input{% if field.errors %} is-invalid{% endif %}"
          id="{{ field.id_for_label }}"
          {% if field.value %}checked{% endif %}>
      </div>

      <!-- Colour picker -->
      {% elif field.field.widget.input_type == "color" %}
      <div>
        <input
          type="color"
          name="{{ field.name }}"
          class="{% if field.errors %}is-invalid{% endif %}"
          id="{{ field.id_for_label }}"
          value="{{ field.value|default_if_none:'' }}"
          placeholder="{{ placeholder|default:'' }}"
          style="width: 4rem; height: 2rem;">
      </div>

      <!-- Everyhting else -->
      {% else %}
        <input
          type="{{ field.field.widget.input_type }}"
          name="{{ field.name }}"
          class="form-control{% if field.errors %} is-invalid{% endif %}"
          id="{{ field.id_for_label }}"
          value="{{ field.value|default_if_none:'' }}"
          placeholder="{{ placeholder|default:'' }}">
      {% endif %}


      <!-- Display small under-text using placeholder -->
      {% if placeholder %}
        <small class="form-text text-muted">{{ placeholder }}</small>
      {% endif %}
    {% endwith %}

    {% if field.errors %}
      <div class="invalid-feedback">
        {{ field.errors|striptags }}
      </div>
    {% endif %}
  </div>
{% endfor %}


<script>
  // Replace the current history state with the same URL to prevent back-button form resubmission
  //window.history.replaceState(null, '', window.location.href);
</script>